<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Game - Test Your Knowledge!</title>
    <link rel="stylesheet" href="output-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { background: #f4f6fa; font-family: 'Poppins', Arial, sans-serif; }
        body {
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(-45deg, #ffecd2, #fcb69f, #a1c4fd, #c2e9fb);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .quiz-container {
            background: rgba(255,255,255,0.85);
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            border-radius: 18px;
            max-width: 430px;
            margin: 60px auto 0 auto;
            padding: 38px 34px 32px 34px;
            backdrop-filter: blur(6px);
            border: 1.5px solid rgba(200,200,255,0.13);
        }
        h1 {
            font-size: 2.2em;
            color: #2563eb;
            text-align: center;
            font-weight: 600;
            margin-bottom: 24px;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 8px #c2e9fb80;
        }
        .select-row {
            display: flex;
            gap: 12px;
            margin-bottom: 18px;
        }
        select, input[type=text] {
            padding: 12px 14px;
            border-radius: 8px;
            border: 1.5px solid #d1d5db;
            font-size: 1em;
            flex: 1;
            background: #f8fafc;
            transition: border 0.2s;
        }
        select:focus, input[type=text]:focus {
            border-color: #2563eb;
            outline: none;
        }
        #play-btn {
            width: 100%;
            margin-top: 10px;
            background: linear-gradient(90deg, #2563eb 60%, #4f8cfb 100%);
            color: #fff;
            font-weight: 600;
            font-size: 1.1em;
            border-radius: 8px;
            box-shadow: 0 2px 12px #2563eb22;
            transition: background 0.2s;
        }
        #play-btn:hover {
            background: linear-gradient(90deg, #1743ae 60%, #2563eb 100%);
        }
        .quiz-container label {
            font-weight: 600;
            color: #444;
            margin-bottom: 4px;
        }
        .error {
            color: #e63946;
            text-align: center;
            margin: 12px 0;
            font-weight: 500;
        }
        .progress {
            margin: 10px 0 0 0;
            color: #2563eb;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        .timer {
            color: #d97706;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: right;
        }
        .actions button {
            background: #2563eb;
            color: #fff;
            border-radius: 7px;
            border: none;
            font-size: 1em;
            font-weight: 600;
            padding: 10px 22px;
            margin: 0 8px;
            box-shadow: 0 2px 8px #2563eb22;
            transition: background 0.2s;
        }
        .actions button:hover:not([disabled]) {
            background: #1743ae;
        }
        .actions button[disabled] {
            background: #bfc8e6;
            cursor: not-allowed;
        }
        #score-area {
            font-size: 1.3em;
            color: #059669;
            text-align: center;
            margin-top: 22px;
            font-weight: 600;
        }
        /* Confetti canvas for celebration */
        #confetti-canvas { pointer-events:none; z-index:999; }
    </style>
    <style id="dark-mode-style" disabled>
      body { background: linear-gradient(-45deg, #232526, #414345, #141e30, #243b55) !important; }
      .quiz-container { background: rgba(30,32,38,0.93) !important; color: #f3f4f6 !important; border: 1.5px solid #333 !important; }
      h1 { color: #93c5fd !important; text-shadow: 0 2px 8px #1e293b80 !important; }
      select, input[type=text] { background: #23272f !important; color: #e0e7ef !important; border: 1.5px solid #374151 !important; }
      #play-btn, .actions button { background: linear-gradient(90deg,#2563eb 60%,#111827 100%) !important; color:#fff !important; }
      #play-btn:hover, .actions button:hover:not([disabled]) { background: linear-gradient(90deg,#1743ae 60%,#2563eb 100%) !important; }
      .error { color: #f87171 !important; }
      .progress { color: #60a5fa !important; }
      .timer { color: #fbbf24 !important; }
    </style>
</head>
<body>
    <div class="quiz-container">
        <h1>Quiz Game</h1>
        <!-- Mascot/illustration and dark mode toggle -->
        <div style="display:flex;justify-content:center;align-items:center;margin-bottom:18px;">
          <img src="images/quiz-mascot.svg" alt="Quiz Mascot" style="height:60px;width:60px;margin-right:14px;box-shadow:0 2px 16px #0001;border-radius:50%;background:#fff;">
          <button id="dark-toggle" style="background:#2563eb;color:#fff;padding:10px 18px;border-radius:8px;font-weight:600;box-shadow:0 2px 8px #2563eb22;"> Dark Mode</button>
        </div>
        <div id="setup-area">
            <div class="select-row">
                <select id="model-select">
                    <option value="gemini">Gemini</option>
                    <option value="openai-mini">OpenAI: o4 Mini High</option>
                    <option value="xai-grok">xAI: Grok 3 Mini Beta</option>
                    <option value="mistral-8b">Mistral: Ministral 8B</option>
                    <option value="kimi-vl">Moonshot Kimi VL A3B (free)</option>
                    <option value="wizardlm">Microsoft WizardLM 2 8x22B</option>
                    <option value="custom">Custom Model</option>
                </select>
                <input id="topic-query" type="text" placeholder="Enter custom topic (optional)" style="flex:1;min-width:120px;">
            </div>
            <div class="select-row">
                <select id="category-select">
                    <option value="">Select Category</option>
                    <option value="General Knowledge">General Knowledge</option>
                    <option value="Science">Science</option>
                    <option value="History">History</option>
                    <option value="Sports">Sports</option>
                    <option value="Technology">Technology</option>
                    <option value="Geography">Geography</option>
                    <option value="Entertainment">Entertainment</option>
                </select>
                <select id="difficulty-select">
                    <option value="">Difficulty</option>
                    <option value="easy">Easy</option>
                    <option value="medium">Medium</option>
                    <option value="hard">Hard</option>
                </select>
            </div>
            <div class="select-row">
                <input id="username-input" type="text" placeholder="Enter your name" style="flex:1;min-width:120px;">
            </div>
            <button id="play-btn" style="margin:0 auto 0 auto;display:block;">Play Quiz</button>
            <div id="setup-error" class="error" style="display:none;"></div>
        </div>
        <div id="quiz-area" style="display:none;">
            <div class="progress" id="progress-bar"></div>
            <div class="timer" id="timer"></div>
            <div id="question-area"></div>
            <div class="actions">
                <button id="prev-btn" disabled>Previous</button>
                <button id="next-btn">Next</button>
                <button id="submit-btn" style="display:none;">Submit</button>
            </div>
        </div>
        <div id="score-area" style="display:none;"></div>
        <div id="confetti-canvas" style="position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:999;display:none;"></div>
        <audio id="correct-sound" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124bfa4b2e.mp3"></audio>
        <audio id="wrong-sound" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124bfa4b2e.mp3"></audio>
    </div>
    <script>
        let questions = [];
        let current = 0;
        let userAnswers = [];
        let timer = null;
        let timeLeft = 20; // seconds per question
        let correctCount = 0;
        let lastQuiz = null;
        let lastUsername = '';
        let lastTopic = '';

        document.getElementById('play-btn').onclick = async function() {
            const model = document.getElementById('model-select').value;
            const topicQuery = document.getElementById('topic-query').value.trim();
            const category = document.getElementById('category-select').value;
            const difficulty = document.getElementById('difficulty-select').value;
            const username = document.getElementById('username-input').value.trim();
            const errorDiv = document.getElementById('setup-error');
            errorDiv.style.display = 'none';
            if (!category && !topicQuery) {
                errorDiv.innerText = 'Please select a category or enter a topic.';
                errorDiv.style.display = '';
                return;
            }
            if (!difficulty) {
                errorDiv.innerText = 'Please select a difficulty.';
                errorDiv.style.display = '';
                return;
            }
            if (!username) {
                errorDiv.innerText = 'Please enter your name.';
                errorDiv.style.display = '';
                return;
            }
            lastUsername = username;
            lastTopic = topicQuery || category;
            document.getElementById('play-btn').disabled = true;
            document.getElementById('play-btn').innerText = 'Generating...';
            try {
                const res = await fetch('/api/quiz/generate-topic', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model,
                        topic: topicQuery || category,
                        category,
                        difficulty
                    })
                });
                let data = null;
                try {
                    data = await res.json();
                } catch (jsonErr) {
                    throw new Error('Quiz generation failed: Invalid response from server.');
                }
                if (!res.ok || !data || !data.questions || !Array.isArray(data.questions) || data.questions.length === 0) {
                    throw new Error((data && data.error) || 'Failed to generate quiz. Try a different topic or model.');
                }
                questions = data.questions;
                lastQuiz = questions;
                current = 0;
                userAnswers = [];
                correctCount = 0;
                document.getElementById('setup-area').style.display = 'none';
                document.getElementById('quiz-area').style.display = '';
                showQuestion(0);
            } catch (err) {
                errorDiv.innerText = err.message || 'Quiz generation failed.';
                errorDiv.style.display = '';
            } finally {
                document.getElementById('play-btn').disabled = false;
                document.getElementById('play-btn').innerText = 'Play Quiz';
            }
        };

        function startTimer() {
            clearInterval(timer);
            timeLeft = 20;
            document.getElementById('timer').innerText = `Time left: ${timeLeft}s`;
            timer = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').innerText = `Time left: ${timeLeft}s`;
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    autoNext();
                }
            }, 1000);
        }
        function autoNext() {
            if (typeof userAnswers[current] === 'undefined') userAnswers[current] = null;
            if (current < questions.length-1) {
                current++;
                showQuestion(current);
            } else {
                document.getElementById('submit-btn').style.display = '';
                document.getElementById('next-btn').style.display = 'none';
                document.getElementById('submit-btn').click();
            }
        }
        // --- Confetti Animation ---
        function launchConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            canvas.style.display = '';
            const ctx = canvas.getContext('2d');
            const W = window.innerWidth, H = window.innerHeight;
            canvas.width = W; canvas.height = H;
            let particles = [];
            for (let i = 0; i < 150; i++) {
                particles.push({
                    x: Math.random() * W,
                    y: Math.random() * H - H,
                    r: Math.random() * 6 + 4,
                    d: Math.random() * 100 + 10,
                    color: `hsl(${Math.random()*360},80%,60%)`,
                    tilt: Math.random() * 10 - 10
                });
            }
            let angle = 0;
            function draw() {
                ctx.clearRect(0, 0, W, H);
                angle += 0.01;
                for (let i = 0; i < particles.length; i++) {
                    let p = particles[i];
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.r, 0, Math.PI*2, false);
                    ctx.fillStyle = p.color;
                    ctx.fill();
                    p.y += Math.cos(angle + p.d) + 1 + p.r/2;
                    p.x += Math.sin(angle) * 2;
                    if (p.y > H) {
                        p.x = Math.random() * W;
                        p.y = -10;
                    }
                }
                requestAnimationFrame(draw);
            }
            draw();
            setTimeout(()=>{canvas.style.display='none';ctx.clearRect(0,0,W,H);}, 3000);
        }
        // --- Sound Feedback ---
        function playSound(correct) {
            const audio = document.getElementById(correct ? 'correct-sound' : 'wrong-sound');
            audio.currentTime = 0;
            audio.play();
        }
        // --- Enhanced showQuestion ---
        function showQuestion(idx) {
            const q = questions[idx];
            let html = `<div class='question'><b>Q${idx+1}:</b> ${q.question}</div><div class='options'>`;
            q.options.forEach((opt, i) => {
                html += `<div class='option'><label><input type='radio' name='option' value='${i}' ${userAnswers[idx] == i ? 'checked' : ''}/> ${String.fromCharCode(65+i)}. ${opt}</label></div>`;
            });
            html += '</div>';
            document.getElementById('question-area').innerHTML = html;
            document.getElementById('prev-btn').disabled = idx === 0;
            document.getElementById('next-btn').style.display = idx === questions.length-1 ? 'none' : '';
            document.getElementById('submit-btn').style.display = idx === questions.length-1 ? '' : 'none';
            document.getElementById('progress-bar').innerText = `Question ${idx+1} of ${questions.length}`;
            startTimer();
            // Animate question
            document.getElementById('question-area').style.opacity = 0;
            setTimeout(()=>{document.getElementById('question-area').style.opacity=1;}, 60);
        }
        // --- Option select feedback ---
        document.getElementById('question-area').addEventListener('change', e => {
            if (e.target.name === 'option') {
                const chosen = parseInt(e.target.value);
                userAnswers[current] = chosen;
                playSound(chosen === questions[current].correct);
            }
        });
        document.getElementById('prev-btn').onclick = () => {
            if (current > 0) { current--; showQuestion(current); }
        };
        document.getElementById('next-btn').onclick = () => {
            if (typeof userAnswers[current] === 'undefined') { alert('Please select an answer!'); return; }
            if (current < questions.length-1) { current++; showQuestion(current); }
        };
        document.getElementById('submit-btn').onclick = async () => {
            if (typeof userAnswers[current] === 'undefined') { alert('Please select an answer!'); return; }
            clearInterval(timer);
            let correct = 0;
            let explanations = [];
            for (let i = 0; i < questions.length; i++) {
                if (userAnswers[i] === questions[i].correct) correct++;
                explanations.push({
                    question: questions[i].question,
                    correct: questions[i].options[questions[i].correct],
                    your: typeof userAnswers[i] === 'number' ? questions[i].options[userAnswers[i]] : null
                });
            }
            // Send answers to backend for result calculation
            try {
                const res = await fetch('/api/quiz', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answers: userAnswers, questions })
                });
                const resultData = await res.json();
                document.getElementById('quiz-area').style.display = 'none';
                document.getElementById('score-area').style.display = '';
                let result = `<div class='score'>You got ${resultData.score} / ${questions.length} correct! 🎉</div>`;
                if (resultData.score/questions.length >= 0.7) launchConfetti();
                result += `<div style='margin:18px 0;'>`;
                (resultData.wrong || explanations).forEach((ex, idx) => {
                    result += `<div style='margin-bottom:10px;'><b>Q${idx+1}:</b> ${ex.question}<br>`;
                    result += `<span style='color:#059669;'>Correct: ${ex.correct_answer || ex.correct}</span><br>`;
                    if (ex.your_answer || ex.your) {
                        if ((ex.your_answer || ex.your) === (ex.correct_answer || ex.correct)) {
                            result += `<span style='color:#059669;'>Your answer: ${(ex.your_answer || ex.your)} ✔️</span>`;
                        } else {
                            result += `<span style='color:#b91c1c;'>Your answer: ${(ex.your_answer || ex.your)} ❌</span>`;
                        }
                    } else {
                        result += `<span style='color:#b91c1c;'>No answer given ❌</span>`;
                    }
                    result += `</div>`;
                });
                result += `</div>`;
                result += `<div style='text-align:center;margin:16px 0;'><button onclick='location.reload()' style='background:#2563eb;color:#fff;border:none;border-radius:6px;padding:10px 24px;font-size:1em;cursor:pointer;'>Play Again</button></div>`;
                document.getElementById('score-area').innerHTML = result;
                document.getElementById('score-area').innerHTML += `
                    <div style='text-align:center;margin:16px 0;'>
                        <input id='name-submit' type='text' placeholder='Enter your name' style='padding:8px;border:1px solid #ccc;border-radius:4px;margin-right:8px;' value='${lastUsername}'>
                        <button id='save-score-btn' style='padding:8px 12px;'>Save Score</button>
                        <button id='view-leaderboard-btn' style='margin-left:8px;padding:8px 12px;'>View Leaderboard</button>
                    </div>
                `;
                document.getElementById('save-score-btn').onclick = async () => {
                    const name = document.getElementById('name-submit').value.trim();
                    if (!name) { alert('Please enter a name to save score'); return; }
                    await fetch('/api/score', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: name, score: resultData.score, topic: lastTopic, timestamp: new Date().toISOString() })
                    });
                    window.location.href = 'leaderboard.html';
                };
                document.getElementById('view-leaderboard-btn').onclick = () => { window.location.href = 'leaderboard.html'; };
            } catch (e) {
                // fallback: show local result
                document.getElementById('quiz-area').style.display = 'none';
                document.getElementById('score-area').style.display = '';
                let result = `<div class='score'>You got ${correct} / ${questions.length} correct! 🎉</div>`;
                if (correct/questions.length >= 0.7) launchConfetti();
                result += `<div style='margin:18px 0;'>`;
                explanations.forEach((ex, idx) => {
                    result += `<div style='margin-bottom:10px;'><b>Q${idx+1}:</b> ${ex.question}<br>`;
                    result += `<span style='color:#059669;'>Correct: ${ex.correct}</span><br>`;
                    if (ex.your !== null) {
                        if (ex.your === ex.correct) {
                            result += `<span style='color:#059669;'>Your answer: ${ex.your} ✔️</span>`;
                        } else {
                            result += `<span style='color:#b91c1c;'>Your answer: ${ex.your} ❌</span>`;
                        }
                    } else {
                        result += `<span style='color:#b91c1c;'>No answer given ❌</span>`;
                    }
                    result += `</div>`;
                });
                result += `</div>`;
                result += `<div style='text-align:center;margin:16px 0;'><button onclick='location.reload()' style='background:#2563eb;color:#fff;border:none;border-radius:6px;padding:10px 24px;font-size:1em;cursor:pointer;'>Play Again</button></div>`;
                document.getElementById('score-area').innerHTML = result;
                document.getElementById('score-area').innerHTML += `
                    <div style='text-align:center;margin:16px 0;'>
                        <input id='name-submit' type='text' placeholder='Enter your name' style='padding:8px;border:1px solid #ccc;border-radius:4px;margin-right:8px;' value='${lastUsername}'>
                        <button id='save-score-btn' style='padding:8px 12px;'>Save Score</button>
                        <button id='view-leaderboard-btn' style='margin-left:8px;padding:8px 12px;'>View Leaderboard</button>
                    </div>
                `;
                document.getElementById('save-score-btn').onclick = async () => {
                    const name = document.getElementById('name-submit').value.trim();
                    if (!name) { alert('Please enter a name to save score'); return; }
                    await fetch('/api/score', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: name, score: correct, topic: lastTopic, timestamp: new Date().toISOString() })
                    });
                    window.location.href = 'leaderboard.html';
                };
                document.getElementById('view-leaderboard-btn').onclick = () => { window.location.href = 'leaderboard.html'; };
            }
        }
    </script>
    <script>
      // Dark mode toggle
      document.addEventListener('DOMContentLoaded', function() {
        const darkBtn = document.getElementById('dark-toggle');
        const darkStyle = document.getElementById('dark-mode-style');
        let dark = false;
        darkBtn.onclick = function() {
          dark = !dark;
          if (dark) {
            darkStyle.removeAttribute('disabled');
            darkBtn.textContent = '☀️ Light Mode';
          } else {
            darkStyle.setAttribute('disabled', '');
            darkBtn.textContent = '🌙 Dark Mode';
          }
        };
      });
    </script>
</body>
</html>
